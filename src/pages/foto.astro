---
import Layout from '../layouts/Layout.astro';
import GalleryCard from '../components/GalleryCard.astro';
import { getCollection } from 'astro:content';

// 1. Preluăm toate pozele
const allPhotos = await getCollection('gallery');

// 2. Sortăm pozele cronologic
const gallery = allPhotos.sort((a, b) => {
  const dateA = new Date(a.data.pubDate || 0).getTime();
  const dateB = new Date(b.data.pubDate || 0).getTime();
  return dateB - dateA;
});

const title = "Foto | Aurelian Epuraș";
const description = "Descoperă universul vizual al lui Aurelian Epuraș (Epuras). Imagini din culise, concerte și momentele în care muzica prinde formă.";
const image = "/uploads/images/Aurelian-Epuras.jpg"; 
const imageAlt = "Aurelian Epuraș | Aurelian Epuras | Pianist Compozitor";

// Date structurate pentru Galerie
const photoSchema = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "ImageGallery",
      "@id": "https://aurelianepuras.github.io/foto/#gallery",
      "name": "Galeria Foto Aurelian Epuraș",
      "description": description,
      "author": { "@id": "https://aurelianepuras.github.io/#person" },
      "image": gallery.map(item => ({
        "@type": "ImageObject",
        "contentUrl": `https://aurelianepuras.github.io${item.data.image}`,
        "name": item.data.title
      }))
    },
    {
      "@type": "WebPage",
      "@id": "https://aurelianepuras.github.io/foto/#webpage",
      "url": "https://aurelianepuras.github.io/foto/",
      "name": title,
      "isPartOf": { "@id": "https://aurelianepuras.github.io/#website" },
      "breadcrumb": { "@id": "https://aurelianepuras.github.io/foto/#breadcrumb" }
    },
    {
      "@type": "BreadcrumbList",
      "@id": "https://aurelianepuras.github.io/foto/#breadcrumb",
      "itemListElement": [
        { "@type": "ListItem", "position": 1, "item": { "@id": "https://aurelianepuras.github.io/", "name": "Acasă" } },
        { "@type": "ListItem", "position": 2, "item": { "@id": "https://aurelianepuras.github.io/foto/", "name": "Foto" } }
      ]
    }
  ]
};
---

<Layout
  title={title}
  description={description}
  image={image}
  imageAlt={imageAlt}
>
  {/* ACEASTĂ LINIE ESTE ESENȚIALĂ PENTRU VERIFICARE: */}
  <script type="application/ld+json" slot="head" is:inline set:html={JSON.stringify(photoSchema)} />
  
  <section class="pt-20 pb-20 bg-ivory dark:bg-navy-deep">
    <div class="container mx-auto px-4">
      <div class="text-center mb-12 max-w-5xl mx-auto">
        <h1 class="font-serif text-4xl md:text-5xl lg:text-6xl text-navy dark:text-ivory-light mb-6">Galerie foto</h1>
        <div class="w-16 h-0.5 bg-gold-warm dark:bg-gold-bright mx-auto mb-6"></div>
        
        <p class="text-left md:text-center text-lg text-navy/70 dark:text-ivory-light/70 leading-relaxed italic md:not-italic">
          Fiecare imagine spune o poveste din spatele scenei, chiar și după ce muzica s-a oprit. 
          Sunt fragmente vizuale care surprind emoția momentului, pasiunea din studio și 
          legătura pe care o am cu fiecare spațiu în care pianul meu prinde viață.
        </p>
      </div>

      <div id="gallery-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {gallery.map((item, index) => (
          <div class="cursor-pointer">
            <GalleryCard
              title={item.data.title}
              image={item.data.image}
              description={item.data.description}
              loading={index < 6 ? "eager" : "lazy"}
              fetchpriority={index < 6 ? "high" : "auto"}
            />
          </div>
        ))}
      </div>
    </div>
  </section>

  <div id="lightbox" role="dialog" aria-modal="true" class="hidden fixed inset-0 z-[9999] bg-[#F7F5F0]/95 dark:bg-[#0B1215]/95 flex items-center justify-center p-4 select-none">
    <button id="lightbox-close" aria-label="Închide galeria" class="absolute top-6 right-6 text-navy dark:text-ivory-light hover:text-gold-warm z-[10001] p-2">
      <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
    </button>

    <button id="lightbox-prev" aria-label="Imaginea anterioară" class="hidden md:flex absolute left-4 md:left-10 text-navy dark:text-ivory-light hover:text-gold-warm z-[10001] p-4 transition-transform hover:scale-110">
      <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
    </button>

    <div class="max-w-5xl w-full flex flex-col items-center">
      <img id="lightbox-image" src="" alt="Imagine galerie" class="max-h-[80vh] w-auto rounded-lg shadow-2xl" />
      <p id="lightbox-description" class="mt-4 text-navy dark:text-ivory-light font-medium"></p>
    </div>

    <button id="lightbox-next" aria-label="Imaginea următoare" class="hidden md:flex absolute right-4 md:right-10 text-navy dark:text-ivory-light hover:text-gold-warm z-[10001] p-4 transition-transform hover:scale-110">
      <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
    </button>
  </div>

  <script>
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-image') as HTMLImageElement | null;
    const lightboxDesc = document.getElementById('lightbox-description');
    const closeBtn = document.getElementById('lightbox-close');
    const prevBtn = document.getElementById('lightbox-prev');
    const nextBtn = document.getElementById('lightbox-next');
    
    const imagesInGrid = Array.from(document.querySelectorAll('#gallery-grid img')) as HTMLImageElement[];
    let currentIndex = 0;

    let touchStartX = 0;
    let touchEndX = 0;

    function openLightbox(index: number) {
      if (!lightbox) return;
      currentIndex = index;
      updateLightbox();
      lightbox.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function updateLightbox() {
      const img = imagesInGrid[currentIndex];
      if (lightboxImg && img) {
        lightboxImg.src = img.src;
        lightboxImg.alt = img.alt || "Imagine galerie Aurelian Epuraș";
        if (lightboxDesc) lightboxDesc.textContent = img.alt || "";
      }
    }

    function closeLightbox() {
      if (!lightbox) return;
      lightbox.classList.add('hidden');
      document.body.style.overflow = '';
    }

    function showNext() {
      if (imagesInGrid.length === 0) return;
      currentIndex = (currentIndex + 1) % imagesInGrid.length;
      updateLightbox();
    }

    function showPrev() {
      if (imagesInGrid.length === 0) return;
      currentIndex = (currentIndex - 1 + imagesInGrid.length) % imagesInGrid.length;
      updateLightbox();
    }

    if (imagesInGrid.length > 0) {
      imagesInGrid.forEach((img, index) => {
        img.addEventListener('click', () => openLightbox(index));
      });
    }

    closeBtn?.addEventListener('click', (e) => { e.stopPropagation(); closeLightbox(); });
    nextBtn?.addEventListener('click', (e) => { e.stopPropagation(); showNext(); });
    prevBtn?.addEventListener('click', (e) => { e.stopPropagation(); showPrev(); });
    
    lightbox?.addEventListener('click', (e) => {
        if (e.target === lightbox) closeLightbox();
    });
    
    document.addEventListener('keydown', (e) => {
      if (lightbox?.classList.contains('hidden')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowRight') showNext();
      if (e.key === 'ArrowLeft') showPrev();
    });

    lightbox?.addEventListener('touchstart', (e: any) => {
      touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });

    lightbox?.addEventListener('touchend', (e: any) => {
      touchEndX = e.changedTouches[0].screenX;
      const swipeDistance = touchEndX - touchStartX;
      if (Math.abs(swipeDistance) > 50) {
        if (swipeDistance > 0) showPrev(); else showNext();
      }
    }, { passive: true });
  </script>
</Layout>